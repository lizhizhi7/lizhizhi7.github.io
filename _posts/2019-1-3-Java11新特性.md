---
layout:     post
title:      Java 11æ–°ç‰¹æ€§
subtitle:   Javaæ–°ä½“éªŒ
date:       2019-1-3
author:     Lee
header-img: img/background-java.jpg
catalog: true
tags:
    - Java
---

> ç¾å›½æ—¶é—´ 09 æœˆ 25 æ—¥ï¼ŒOralce æ­£å¼å‘å¸ƒäº† Java 11ï¼Œè¿™æ˜¯æ® Java 8 ä»¥åæ”¯æŒçš„é¦–ä¸ªé•¿æœŸç‰ˆæœ¬ã€‚

ç°åœ¨[Java 11](https://www.oracle.com/technetwork/java/javase/downloads/jdk11-downloads-5066655.html)é•¿æœŸæ”¯æŒï¼Œä¹Ÿå·²ç»åŒ…å«äº† 9 å’Œ 10 çš„å…¨éƒ¨åŠŸèƒ½ï¼Œé‚£ä¹ˆæˆ‘ä»¬æ¥çœ‹ä¸‹ ä» Java 9 - 11 éƒ½æœ‰å“ªäº›é‡è¦çš„æ–°ç‰¹æ€§å‘¢ï¼Ÿ

### æ–°ç‰¹æ€§

æ ¹æ®å®˜ç½‘çš„å…¬å¼€ä¿¡æ¯ï¼Œæ­¤å¤„çš„Java 11ä¸»è¦æ›´æ–°äº† 17 ä¸ª JEPã€‚

* 181: Nest-Based Access Controlï¼ˆåŸºäºåµŒå¥—çš„è®¿é—®æ§åˆ¶ï¼‰
* 309: Dynamic Class-File Constantsï¼ˆåŠ¨æ€çš„ç±»æ–‡ä»¶å¸¸é‡ï¼‰
* 315: Improve Aarch64 Intrinsicsï¼ˆæ”¹è¿› Aarch64 Intrinsicsï¼‰
* 318: Epsilon: A No-Op Garbage Collectorï¼ˆEpsilon åƒåœ¾å›æ”¶å™¨ï¼Œåˆè¢«ç§°ä¸º"No-Opï¼ˆæ— æ“ä½œï¼‰"å›æ”¶å™¨ï¼‰
* 320: Remove the Java EE and CORBA Modulesï¼ˆç§»é™¤ Java EE å’Œ CORBA æ¨¡å—ï¼ŒJavaFX ä¹Ÿå·²è¢«ç§»é™¤ï¼‰
* 321: HTTP Client (Standard)
* 323: Local-Variable Syntax for Lambda Parametersï¼ˆç”¨äº Lambda å‚æ•°çš„å±€éƒ¨å˜é‡è¯­æ³•ï¼‰
* 324: Key Agreement with Curve25519 and Curve448ï¼ˆé‡‡ç”¨ Curve25519 å’Œ Curve448 ç®—æ³•å®ç°çš„å¯†é’¥åè®®ï¼‰
* 327: Unicode 10
* 328: Flight Recorderï¼ˆé£è¡Œè®°å½•ä»ªï¼‰
* 329: ChaCha20 and Poly1305 Cryptographic Algorithmsï¼ˆå®ç° ChaCha20 å’Œ Poly1305 åŠ å¯†ç®—æ³•ï¼‰
* 330: Launch Single-File Source-Code Programsï¼ˆå¯åŠ¨å•ä¸ª Java æºä»£ç æ–‡ä»¶çš„ç¨‹åºï¼‰
* 331: Low-Overhead Heap Profilingï¼ˆä½å¼€é”€çš„å †åˆ†é…é‡‡æ ·æ–¹æ³•ï¼‰
* 332: Transport Layer Security (TLS) 1.3ï¼ˆå¯¹ TLS 1.3 çš„æ”¯æŒï¼‰
* 333: ZGC: A Scalable Low-Latency Garbage Collector (Experimental)ï¼ˆZGCï¼šå¯ä¼¸ç¼©çš„ä½å»¶è¿Ÿåƒåœ¾å›æ”¶å™¨ï¼Œå¤„äºå®éªŒæ€§é˜¶æ®µï¼‰
* 335: Deprecate the Nashorn JavaScript Engineï¼ˆå¼ƒç”¨ Nashorn JavaScript å¼•æ“ï¼‰
* 336: Deprecate the Pack200 Tools and APIï¼ˆå¼ƒç”¨ Pack200 å·¥å…·åŠå…¶ APIï¼‰

### æ–°ä½“éªŒ

#### æœ¬åœ°å˜é‡ç±»å‹æ¨æ–­

```java
var javastack = "javastack";
System.out.println(javastack);
```

å±€éƒ¨å˜é‡ç±»å‹æ¨æ–­å°±æ˜¯å·¦è¾¹çš„ç±»å‹ç›´æ¥ä½¿ç”¨`var`å®šä¹‰ï¼Œè€Œä¸ç”¨å†™å…·ä½“çš„ç±»å‹ï¼Œç¼–è¯‘å™¨èƒ½æ ¹æ®å³è¾¹çš„è¡¨è¾¾å¼è‡ªåŠ¨æ¨æ–­ç±»å‹ï¼Œå¦‚ä¸Šé¢çš„`String`ã€‚PS.æ„Ÿè§‰ç°åœ¨æ‰€æœ‰è¯­è¨€éƒ½å¯ä»¥ç”¨varæ¥æ¨æ–­å˜é‡äº†ï¼Œä¸è¿‡ES6æ¨èä½¿ç”¨letäº†ğŸ˜‚ã€‚
> Java 10ä¸­å·²ç»å®ç°äº†ç±»å‹æ¨æ–­ï¼Œåœ¨Java 11ä¸­è¿˜å¯ä»¥åœ¨Lambdaè¡¨è¾¾å¼ä¸­ä½¿ç”¨

#### å­—ç¬¦ä¸²åŠ å¼º

Java 11 å¢åŠ äº†ä¸€ç³»åˆ—çš„å­—ç¬¦ä¸²å¤„ç†æ–¹æ³•ã€‚

```java
// åˆ¤æ–­å­—ç¬¦ä¸²æ˜¯å¦ä¸ºç©ºç™½
" ".isBlank(); // true
// å»é™¤é¦–å°¾ç©ºæ ¼
" Javastack ".strip(); // "Javastack"
// å»é™¤å°¾éƒ¨ç©ºæ ¼
" Javastack ".stripTrailing(); // " Javastack"
// å»é™¤é¦–éƒ¨ç©ºæ ¼
" Javastack ".stripLeading(); // "Javastack "
// å¤åˆ¶å­—ç¬¦ä¸²
"Java".repeat(3); // "JavaJavaJava"
// è¡Œæ•°ç»Ÿè®¡
"A\nB\nC".lines().count(); // 3
```

#### é›†åˆåŠ å¼º

è‡ª Java 9 å¼€å§‹ï¼ŒJDK é‡Œé¢ä¸ºé›†åˆï¼ˆList/ Set/ Mapï¼‰éƒ½æ·»åŠ äº† of å’Œ copyOf æ–¹æ³•ï¼Œå®ƒä»¬ä¸¤ä¸ªéƒ½ç”¨æ¥åˆ›å»ºä¸å¯å˜çš„é›†åˆï¼Œæ¥çœ‹ä¸‹å®ƒä»¬çš„ä½¿ç”¨å’ŒåŒºåˆ«ã€‚

ç¤ºä¾‹1ï¼š

```java
var list = List.of("Java", "Python", "C");
var copy = List.copyOf(list);
System.out.println(list == copy);  // true
```

ç¤ºä¾‹2ï¼š

```java
var list = new ArrayList<String>();
var copy = List.copyOf(list);
System.out.println(list == copy);  // false
```

ç¤ºä¾‹1å’Œ2ä»£ç å·®ä¸å¤šï¼Œä¸ºä»€ä¹ˆä¸€ä¸ªä¸ºtrue,ä¸€ä¸ªä¸ºfalse?

æ¥çœ‹ä¸‹å®ƒä»¬çš„æºç ï¼š

```java
static <E> List<E> of(E... elements) {
    switch (elements.length) { // implicit null check of elements
        case 0:
            return ImmutableCollections.emptyList();
        case 1:
            return new ImmutableCollections.List12<>(elements[0]);
        case 2:
            return new ImmutableCollections.List12<>(elements[0], elements[1]);
        default:
            return new ImmutableCollections.ListN<>(elements);
    }
}
static <E> List<E> copyOf(Collection<? extends E> coll) {
    return ImmutableCollections.listCopy(coll);
}
static <E> List<E> listCopy(Collection<? extends E> coll) {
    if (coll instanceof AbstractImmutableList && coll.getClass() != SubList.class) {
        return (List<E>)coll;
    } else {
        return (List<E>)List.of(coll.toArray());
    }
}
```

å¯ä»¥çœ‹å‡º copyOf æ–¹æ³•ä¼šå…ˆåˆ¤æ–­æ¥æºé›†åˆæ˜¯ä¸æ˜¯ AbstractImmutableList ç±»å‹çš„ï¼Œå¦‚æœæ˜¯ï¼Œå°±ç›´æ¥è¿”å›ï¼Œå¦‚æœä¸æ˜¯ï¼Œåˆ™è°ƒç”¨ of åˆ›å»ºä¸€ä¸ªæ–°çš„é›†åˆã€‚

ç¤ºä¾‹2å› ä¸ºç”¨çš„ new åˆ›å»ºçš„é›†åˆï¼Œä¸å±äºä¸å¯å˜ AbstractImmutableList ç±»çš„å­ç±»ï¼Œæ‰€ä»¥ copyOf æ–¹æ³•åˆåˆ›å»ºäº†ä¸€ä¸ªæ–°çš„å®ä¾‹ï¼Œæ‰€ä»¥ä¸ºfalse.

æ³¨æ„ï¼šä½¿ç”¨ of å’Œ copyOf åˆ›å»ºçš„é›†åˆä¸ºä¸å¯å˜é›†åˆï¼Œä¸èƒ½è¿›è¡Œæ·»åŠ ã€åˆ é™¤ã€æ›¿æ¢ã€æ’åºç­‰æ“ä½œï¼Œä¸ç„¶ä¼šæŠ¥ java.lang.UnsupportedOperationException å¼‚å¸¸ã€‚

ä¸Šé¢æ¼”ç¤ºäº† List çš„ of å’Œ copyOf æ–¹æ³•ï¼ŒSet å’Œ Map æ¥å£éƒ½æœ‰ã€‚

#### Stream åŠ å¼º

Stream æ˜¯ Java 8 ä¸­çš„æ–°ç‰¹æ€§ï¼ŒJava 9 å¼€å§‹å¯¹ Stream å¢åŠ äº†ä»¥ä¸‹ 4 ä¸ªæ–°æ–¹æ³•ã€‚

1) å¢åŠ å•ä¸ªå‚æ•°æ„é€ æ–¹æ³•ï¼Œå¯ä¸ºnull

Stream.ofNullable(null).count(); // 0
2) å¢åŠ  takeWhile å’Œ dropWhile æ–¹æ³•

Stream.of(1, 2, 3, 2, 1)
    .takeWhile(n -> n < 3)
    .collect(Collectors.toList());  // [1, 2]
ä»å¼€å§‹è®¡ç®—ï¼Œå½“ n < 3 æ—¶å°±æˆªæ­¢ã€‚

Stream.of(1, 2, 3, 2, 1)
    .dropWhile(n -> n < 3)
    .collect(Collectors.toList());  // [3, 2, 1]
è¿™ä¸ªå’Œä¸Šé¢çš„ç›¸åï¼Œä¸€æ—¦ n < 3 ä¸æˆç«‹å°±å¼€å§‹è®¡ç®—ã€‚

3ï¼‰iterateé‡è½½

è¿™ä¸ª iterate æ–¹æ³•çš„æ–°é‡è½½æ–¹æ³•ï¼Œå¯ä»¥è®©ä½ æä¾›ä¸€ä¸ª Predicate (åˆ¤æ–­æ¡ä»¶)æ¥æŒ‡å®šä»€ä¹ˆæ—¶å€™ç»“æŸè¿­ä»£ã€‚

å¦‚æœä½ å¯¹ JDK 8 ä¸­çš„ Stream è¿˜ä¸ç†Ÿæ‚‰ï¼Œå¯ä»¥è‡ªè¡Œç™¾åº¦ä¸‹æ•™ç¨‹ã€‚

#### Optional åŠ å¼º

Optional ä¹Ÿå¢åŠ äº†å‡ ä¸ªéå¸¸é…·çš„æ–¹æ³•ï¼Œç°åœ¨å¯ä»¥å¾ˆæ–¹ä¾¿çš„å°†ä¸€ä¸ª Optional è½¬æ¢æˆä¸€ä¸ª Stream, æˆ–è€…å½“ä¸€ä¸ªç©º Optional æ—¶ç»™å®ƒä¸€ä¸ªæ›¿ä»£çš„ã€‚

```java
Optional.of("javastack").orElseThrow();     // javastack
Optional.of("javastack").stream().count();  // 1
Optional.ofNullable(null)
    .or(() -> Optional.of("javastack"))
    .get();   // javastack
```

#### InputStream åŠ å¼º

InputStream ç»ˆäºæœ‰äº†ä¸€ä¸ªéå¸¸æœ‰ç”¨çš„æ–¹æ³•ï¼štransferToï¼Œå¯ä»¥ç”¨æ¥å°†æ•°æ®ç›´æ¥ä¼ è¾“åˆ° OutputStreamï¼Œè¿™æ˜¯åœ¨å¤„ç†åŸå§‹æ•°æ®æµæ—¶éå¸¸å¸¸è§çš„ä¸€ç§ç”¨æ³•ï¼Œå¦‚ä¸‹ç¤ºä¾‹ã€‚

```java
var classLoader = ClassLoader.getSystemClassLoader();
var inputStream = classLoader.getResourceAsStream("javastack.txt");
var javastack = File.createTempFile("javastack2", "txt");
try (var outputStream = new FileOutputStream(javastack)) {
    inputStream.transferTo(outputStream);
}
```

#### HTTP Client API

è¿™æ˜¯ Java 9 å¼€å§‹å¼•å…¥çš„ä¸€ä¸ªå¤„ç† HTTP è¯·æ±‚çš„ APIï¼Œè¯¥ API æ”¯æŒåŒæ­¥å’Œå¼‚æ­¥ï¼Œè€Œåœ¨ Java 11 ä¸­å·²ç»ä¸ºæ­£å¼å¯ç”¨çŠ¶æ€ï¼Œä½ å¯ä»¥åœ¨ java.net åŒ…ä¸­æ‰¾åˆ°è¿™ä¸ª APIã€‚

```java
var request = HttpRequest.newBuilder()
    .uri(URI.create("https://javastack.cn"))
    .GET()
    .build();
var client = HttpClient.newHttpClient();
// åŒæ­¥
HttpResponse<String> response = client.send(request, HttpResponse.BodyHandlers.ofString());
System.out.println(response.body());
// å¼‚æ­¥
client.sendAsync(request, HttpResponse.BodyHandlers.ofString())
    .thenApply(HttpResponse::body)
    .thenAccept(System.out::println);
```

ä¸Šé¢çš„ .GET() å¯ä»¥çœç•¥ï¼Œé»˜è®¤è¯·æ±‚æ–¹å¼ä¸º Getï¼

#### åŒ–ç¹ä¸ºç®€ï¼Œä¸€ä¸ªå‘½ä»¤ç¼–è¯‘è¿è¡Œæºä»£ç 

çœ‹ä¸‹é¢çš„ä»£ç ã€‚

```bash
// ç¼–è¯‘
javac Javastack.java
// è¿è¡Œ
java Javastack
```

åœ¨æˆ‘ä»¬çš„è®¤çŸ¥é‡Œé¢ï¼Œè¦è¿è¡Œä¸€ä¸ª Java æºä»£ç å¿…é¡»å…ˆç¼–è¯‘ï¼Œå†è¿è¡Œï¼Œä¸¤æ­¥æ‰§è¡ŒåŠ¨ä½œã€‚è€Œ Java 11 ç‰ˆæœ¬ä¸­ï¼Œé€šè¿‡ä¸€ä¸ª java å‘½ä»¤å°±ç›´æ¥æå®šäº†ï¼Œå¦‚ä»¥ä¸‹æ‰€ç¤ºã€‚

```bash
java Javastack.java
```

### ä¼ é€é—¨

* [JDK 11 å‘å¸ƒè¯´æ˜](https://www.oracle.com/technetwork/java/javase/11u-relnotes-5093844.html)

* [JDK 11 å®˜æ–¹æ–‡æ¡£](https://docs.oracle.com/en/java/javase/11/)

* [JDK 11 æ–°ç‰¹æ€§](https://www.oracle.com/technetwork/java/javase/11-relnote-issues-5012449.html#NewFeature)
